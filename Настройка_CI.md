Для настройки CI используется Jenkins, ссылка на директорию проекта:
https://sberworks.ru/jenkins-ci/job/depsmgmt/. Для каждого репозитория
или сервиса создается своя директория, в которой описываются пайплайны,
относящиеся к соответствующему репозиторию. Креды для доступа к проекту
должны быть уникальными для каждого репозитория, должны быть
соответствующе проименованы.

Для проекта сконфигурированы настройки Maven, без которых невозможна
сборка проекта. Просмотреть содержание файла можно, зайдя в папку
проекта и открыв вкладку \"Config files\". Также в папке проекта можно
увидеть все директории, созданные для репозиториев / сервисов проекта.

Настройка пайплайна в веб-интерфейсе Дженкинса заключается в следующем:

1\) В общей директории проекта необходимо создать новой объект (New
Item), который должен являться папкой (Folder). Имя папки должно
совпадать с именем репозитория / сервиса, для которого она создается.

2\) В созданной папке необходимо создать новый объекта, который должен
являться пайплайном (Pipeline). Имя пайплайна должен отражать
СI-процессы, которые он будет выполнять.

3\) В настройках пайплайна необходимо:

3.1) Указать, что использоваться будет Generic Webhook Trigger (раздел
Build Triggers). Такой триггер используется, так как мы хотим передавать
в запросе к Дженкинсу нужную нам информацию.

В \"Post content parameters\" необходимо добавить переменную
\"PR_BRANCH\" с выражением \"\$.pullRequest.fromRef.id\" и указанием,
что это JSONPath. Эта переменная будет отвечать за то, какую ветку мы
будем собирать.

3.2) В разделе настроек \"Pipeline\" указать определение (Definition)
\"Pipeline script from SCM\", в качестве SCM - Bitbucket Server, затем -
путь нужному репозиторию / сервису. Указываемые креды должны относится
только к настраиваемого пайплайну и должны быть проименованы в
соотвествии с названием репозитория / сервиса.

3.3) В разделе Pipeline -\> Branches to build необходимо указать
\$PR_BRANCH - смысл будет описан дальше.

4\) В проекте необходимо:

4.1) Создать в корне файл с именем Jenkinsfile, который будет основной
конфигурацией сборки. Файл пишется на языке Groovy. Пример файла
конфигурации приведен в docs/Jenkinsfile. В файле существует раздел
triggers, где приведена обработка ранее созданного GenericTrigger. У
GenericTrigger существуют поля, которые подлежат настройке: в
genericVariables указана обработка переменной PR_BRANCH, которая
является исходной веткой пулл реквеста и является той веткой, которую мы
хотим собрать (именно поэтому в 3.3 мы указали ее), в token - токен,
обеспечивающий связь триггера и Дженкинса. Токен должен быть уникальным
для пайплайна и отражать название репозитория / сервиса, к которому он
принадлежит.

4.2) Приведенный Jenkinsfile является универсальным. На первом шаге
проверяется имя коммита, для чего используется RegEx-выражение. На
втором проводится сборка проекта с указанием Id файла настроек Maven
(файл лежит в конфигурации корневой директории проекта в Дженкинсе). На
третьем шаге выполняется команда verify, то есть проводится
тестирование, анализ покрытия кода тестами, анализ pmd.

5\) В Bitbucket необходимо:

5.1) Создать в соответствующем репозитории вебхук (Settings -\>
Webhooks), где указать его URL в виде
\"https://sberworks.ru/jenkins-ci/generic-webhook-trigger/invoke?token=\$TOKEN\$\",
где \$TOKEN\$ - ранее указанный в Jenkinsfile токен (раздел
GenericTrigger). В разделе Events необходимо выбрать события Opened и
Source branch updated (подраздел Pull request).

5.2) В разделе Merge checks (Settings -\> Pull Requests -\> Merge
Checks) необходимо указать: All reviewers approve, Minimum successful
builds (количество успешных сборок - 1).

5.3) В разделе Branch permissions (Settings -\> Security -\> Branch
permissions) необходимо добавить настройку, где для ветки мастер указать
prevent-значение Changes without a pull request.

6\) Далее необходимо проверить работу всей настроенной CI-системы путем
открытия пулл реквеста в мастер и обновления ветки, из которой создан
этот пулл реквест. В настройках пайплайна в Дженкинсе в разделе Generic
Webhook Trigger должно появится значение в разделе Post content
parameters, отображающее переменную PR_BRANCH, ранее настроенную в
Jenkinsfile.

Критерии успешности настройки: в Дженкинсе отрабатывает пайплайн с
успешным выполнением всех стадий, успешность сборки отображается в
Bitbucket (в разделе Branches, а так же в окне открытого Pull Request).
